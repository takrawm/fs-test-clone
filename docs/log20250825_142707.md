

## 前提

-   プロジェクト目的:
    実績BS/PLから計画BS/PLを算出し、CFを自動生成するWebアプリ。
-   実装言語: TypeScript。
-   仕様書では、FAMモデル（FY×Accountマトリクス）上にCell（=Node拡張）を保持し、Parameters型やBalance&Change型のロジックで計画値を計算する方針が示されている。
-   初期コードはPL単体・単年のAST構築を中心に書かれていた。

------------------------------------------------------------------------

## スレッド全体の議論フロー

まず、PLを通る現金科目のみでテストを構築した。

### 1. テスト改善要求

-   PREV を PREVS に変更（複数年実績を持つ前提）。
-   EXPECT も EXPECTS として複数年期待値を保持。
-   実績の最終年から計画1年目を算出し、その値を計画2年目の計算に利用するテストを追加。

### 2. RULES → AST → 計算 → FAM 書戻し

-   これまでのコードでは「AST構築と評価」がFAMから独立しており、FAM上の表ビューと直結していなかった。
-   改善点:
    -   ユーザー定義実績値をFAMに取り込み。
    -   RULESを適用してASTを構築。
    -   ASTによる計算結果をFAMセルに書戻す。
    -   表ビュー抽出で最終的にUIへ提供。

### 3. 実装修正ポイント

-   **現金算出ロジック**\
    旧: compute時に現金をensureCell → ルール未定義でエラー。\
    新: RULES科目のみensureCell →
    attachCash()で「現金=現金(prev)+基点利益」を作る。
-   **ファイル分割**\
    `fam/`, `engine/ast.ts`, `engine/eval.ts`, `tests/` に整理。
-   **NodeID**\
    日本語科目名を使うのは筋が悪いため、UUID/安定ID採用。DOTラベルには科目名を表示。

### 4. エラーとデバッグ履歴

-   **cash shell missing FY2003**\
    computeで現金をensureCell対象にしていたことが原因。修正で解決。
-   **rowIdxByName('営業利益') が -1**\
    表ビューに営業利益行が出なかった。\
    → ensureAccountで派生科目もorderAccountsに追加し、getTableに反映。

### 5. FAMの設計方針

-   **役割**:
    グローバル状態変数として全ての実績・予測を保持し、表ビューを返す。
-   **API例**:
    -   `importActuals(PREVS)`
    -   `setRules(RULES)`
    -   `compute({years})`
    -   `getTable({fs, years})`
-   **設計ポイント**:
    -   計算結果は常にFAMセルに書戻す（再計算は上書き）。
    -   RULES変更時は依存部分のみ再計算可能。

### 6. AST保持の是非

-   各セルごとにASTを構築し、計画期が進むごとに既存ASTの上にノードを追加可能。
-   1年目ASTから拡張して2年目ASTを作る運用が可能。
-   FAMがASTを直接保持するかはトレードオフ：
    -   メモリ効率 vs 再利用性・可視化性。
    -   現状は「FAMがNodeRegistryとrootsを保持し、セル単位ASTを参照」方針。

### 7. 将来拡張

-   BS/CF/PP&Eなどの他シート追加。
-   シナリオ管理（Base/Downside）。
-   Balance&Change型（設備投資・減価償却等）。
-   ノード禁則（TTがTT×2の子を持たないルール）は今は警告。

------------------------------------------------------------------------

## 結論

-   FAMは表ビュー提供のための中核。
-   ASTはセル単位で構築し、FAM上に反映。
-   現金はattachCashで処理する設計に統一。
-   今後の拡張（BS/CF/シナリオ管理等）に耐えられる設計。

------------------------------------------------------------------------

## まとめ図解（概念）

実績PREVS → **FAM.importActuals**\
RULES → **FAM.setRules**\
逐次計算 → **FAM.compute**（AST構築・評価）\
結果書戻し → **FAM.table**\
UI → **FAM.getTable** で表ビュー抽出

------------------------------------------------------------------------
